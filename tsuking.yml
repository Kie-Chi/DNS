name: "Chi-Remote-TsuKing"
inet: 10.66.0.0/24
include: resource:/includes/traffic.yml
images:
  - name: "unbound"
    ref: "unbound:1.17.1"
  - name: "python39"
    ref: "python:3.9.0"

builds:
  - auth:
      image: "python39"
      volumes:
        - git://github.com/Kie-Chi/DNS.git?ref=remote-tsuking#server.py:/usr/local/etc/server.py
      command: "python3 /usr/local/etc/server.py"
  - victim:
      image: "python39"
      command: "tail -f /dev/null"
  - fl:
      image: "unbound"
      volumes:
        - git://github.com/Kie-Chi/DNS.git?ref=remote-tsuking#weak.conf:/usr/local/etc/unbound/unbound.conf
      build: false
  - rl:
      image: "unbound"
      volumes:
        - git://github.com/Kie-Chi/DNS.git?ref=remote-tsuking#weak.conf:/usr/local/etc/unbound/unbound.conf
      behavior: example.com stub auth
      build: false
  - name: "fl-{{ i }}"
    for_each:
      range: 16
    template:
      ref: "fl"
      behavior: ". forward rl-{{ i }}"
  - name: "rl-{{ i }}"
    for_each:
      range: 16
    template:
      ref: "rl"
  - attacker:
      image: "python39"
      command: "tail -f /dev/null"
      volumes:
        - git://github.com/Kie-Chi/Cpings.git#.:/usr/local/etc/Cpings
        - git://github.com/Kie-Chi/DNS.git?ref=remote-tsuking#probe.c:/usr/local/etc/Cpings/src/myprobe.c
      environment:
        - "ENTRY=${services.fl-1.ip}"
  - traffic:
      environment:
        - "RECURSOR=" # dns_analyzer will fail for null
        - "ATTACKER=${services.attacker.ip}" # no use
        - "SOFTWARE=${services.rl-0.image.software}" # no use
        - "FILTER=udp and port 53 and dst host ${services.victim.ip}"
        - "POLL_GAP=3000"
      volumes:
        - ${origin}./${name}/contents:/usr/local/var/unbound:rw # no use
      container_name: ${project.name}-${name}